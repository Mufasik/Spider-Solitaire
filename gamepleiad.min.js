var timer,timerstep=0,counter,counterx,countery,stack,tempstack,button=!1,started=!1,newPosXY={},lastentry,xcard=37,ycard=25,pscore,pmoves,pcancel=[],pview=[];function CancelViewMove(d,e,f,g){this.oldx=d;this.x=e;this.c=f;this.blank=g}
function CancelMoveClick(){c=b=y=0;if(0==timerstep&&0<pcancel.length){c=pcancel.pop();y=stack[c.oldx].length;c.blank&&0!=y&&(y--,$(".pos-"+c.oldx+"-"+y).remove(),DrawOneCard(c.oldx,y,1));y=stack[c.x].length-c.c;a=stack[c.oldx].length;for(i=0;i<c.c;i++)b=stack[c.x].splice(y,1),stack[c.oldx].push(b);for(i=0;i<c.c;i++)$(".pos-"+c.x+"-"+y).remove(),DrawOneCard(c.oldx,a,0),y++,a++;pmoves++;pscore--;TextEdit(!0)}}
function AnimateCardDown(d){timerstep++;for(j=0;10>j;j++)a=stack[j].length,b=25*a/100,z=-75-25*a+Math.round(d*b),a--,$(".pos-"+j+"-"+a).css({"margin-top":z});101>timerstep?timer=setTimeout("AnimateCardDown("+timerstep+")",10):(clearTimeout(timer),timerstep=0,GameReDrawAnim())}
function AnimateCardUp(d,e){j=stack[e].length-12;for(l=0;12>l;l++)z=-75-timerstep,$(".pos-"+e+"-"+j).css({"margin-top":z}),j++;timerstep++;if(26>timerstep)timer=setTimeout("AnimateCardUp("+timerstep+", "+e+")",20);else{for(l=0;12>l;l++)j=stack[e].length-1-l,$(".pos-"+e+"-"+j).css({"margin-top":"-75px"});GameReDraw(e);clearTimeout(timer);timerstep=0}}
function WhatMoveAnimate(d,e,f,g){j=stack[f].length;k=stack[e].length-1;z=25>d?1-.04*d:.04*(d-25);0==j?$("#column-"+f+".space").css({opacity:z}):(j--,$(".pos-"+f+"-"+j).css({opacity:z}));for(l=0;l<g;l++)$(".pos-"+e+"-"+k).css({opacity:z}),k--;timerstep++;51>timerstep?timer=setTimeout("WhatMoveAnimate("+timerstep+", "+e+", "+f+", "+g+")",10):(clearTimeout(timer),timerstep=0)}function WhatMoveClick(){0==timerstep&&(pc=pview.shift(),pview.push(pc),WhatMoveAnimate(timerstep,pc.oldx,pc.x,pc.c))}
function WhatMoveView(){pview=[];for(i=0;10>i;i++)TempStackCreate(i);for(i=0;10>i;i++)for(j=0;10>j;j++)i!=j&&(l=stack[i].length,m=stack[j].length,k=l-tempstack[i],k!=l&&(a=stack[i][k],a=stack[i][k]%20+1,b=0<m?stack[j][m-1]%20:0,a==b&&(pc=new CancelViewMove(i,j,tempstack[i],!0),pview.push(pc))))}function TempStackCreate(d){s=stack[d].length;tempstack[d]=0;none=!0;for(j=0;j<s&&none;)CardOrder(d,j),0<counter&&(tempstack[d]=counter,none=!1),j++}
function CardBlank(d,e){return $(".pos-"+d+"-"+e).hasClass("blank")}
function DrawOneCard(d,e,f){11==d&&$("#column-"+d).append("<div class = 'cardsr pos-11-"+e+" color-"+stack[d][e]+"' ></div>");10==d&&$("#column-"+d).append("<div class = 'cardsl blank pos-10-"+e+"' onclick = 'CardMClick("+e+")' ></div>");10>d&&2>f&&($("#column-"+d).append("<div class = 'card pos-"+d+"-"+e+"' onmousedown = 'CardMDown("+d+", "+e+", "+f+")' ></div>"),0==f?$(".pos-"+d+"-"+e).toggleClass("color-"+stack[d][e],!0):$(".pos-"+d+"-"+e).toggleClass("blank",!0));2==f&&$("#temp").append("<div class = 'holder card color-"+
stack[d][e]+"' ></div>")}function TextEdit(d){WhatMoveView();d?$("p#textvalue").text("\u0421\u0447\u0435\u0442: "+pscore+", \u0425\u043e\u0434\u043e\u0432: "+pmoves):$("p#textvalue").text("\u0412\u044b \u0432\u044b\u0439\u0433\u0440\u0430\u043b\u0438!!! \u0421\u0447\u0435\u0442: "+pscore+", \u0425\u043e\u0434\u043e\u0432: "+pmoves)}
function CheckColumn(){lastentry=10;colPosXY=$("#column-0").offset();if(colPosXY.top<newPosXY.top){lastentry=Math.floor((newPosXY.left+xcard-colPosXY.left)/(xcard+xcard));if(0>lastentry||9<lastentry)lastentry=10;a=stack[lastentry].length*ycard+7*ycard;b=newPosXY.top+ycard-colPosXY.top;a<b&&(lastentry=10)}}function CardOrder(d,e){if(CardBlank(d,e))counter=z=0;else{for(z=1+e;z<stack[d].length&&z!=e;)u=stack[d][z-1],v=stack[d][z],v++,u==v?z++:z=e;counter=z-e}}
function CardMClick(d){if(0==timerstep&&(j=b=a=0,l=10,noempty=!0,0!=stack[10].length&&(l=stack[10].length/10-1),5==d&&10!=l&&(d=l),l==d)){for(;10>b&&noempty;)0==stack[b].length&&(noempty=!1),b++;if(noempty){a=stack[10].length-10;for(i=0;10>i;i++)b=stack[10].splice(a,1),stack[i].push(b),j=stack[i].length-1,DrawOneCard(i,j,0);$(".pos-10-"+l).remove();AnimateCardDown(timerstep);pcancel=[];TextEdit(!0)}else $("p#textvalue").text("\u0414\u043b\u044f \u0441\u0434\u0430\u0447\u0438 \u043a\u0430\u0440\u0442 \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e \u0437\u0430\u043f\u043e\u043b\u043d\u0438\u0442\u044c \u043f\u0443\u0441\u0442\u044b\u0435 \u043f\u043e\u043b\u044f")}}
function CardMDown(d,e,f){if(0==timerstep&&0==f&&(CardOrder(d,e),0<counter)){counterx=d;countery=e;j=0;j=e;for(i=0;i<counter;i++)DrawOneCard(d,j,2),$(".pos-"+d+"-"+j).toggleClass("notholder",!0),j++;$("#temp").offset(newPosXY);button=!0}}
function CardMUp(d){if(d!=counterx&&0<counter&&10>d&&(b=a=0,y=stack[d].length,0!=y&&(b=stack[d][y-1]%20),a=stack[counterx][countery]%20+1,a==b||0==b)){a=stack[counterx].length-counter;blank=!1;1<=a&&(b=a-1,CardBlank(counterx,b)&&(blank=!0));for(i=0;i<counter;i++)b=stack[counterx].splice(a,1),stack[d].push(b);a=countery;for(i=0;i<counter;i++)$(".pos-"+counterx+"-"+a).remove(),DrawOneCard(d,y,0),y++,a++;pmoves++;pscore--;pc=new CancelViewMove(counterx,d,counter,blank);pcancel.push(pc);GameReDrawAnim()}}
function GameReDrawAnim(){for(x=0;10>x;x++)y=stack[x].length,0!=y&&(--y,CardBlank(x,y)&&($(".pos-"+x+"-"+y).remove(),DrawOneCard(x,y,0))),y=stack[x].length,12<y&&(a=y-13,CardOrder(x,a),blank=CardBlank(x,a),13!=counter||blank||AnimateCardUp(timerstep,x));TextEdit(!0)}
function GameReDraw(d){b=a=stack[d].length-13;z=stack[d][a];for(i=0;13>i;i++)stack[d].splice(a,1),$(".pos-"+d+"-"+b).remove(),b++;stack[11].push(z);z=stack[11].length-1;DrawOneCard(11,z,1);pcancel=[];pscore+=100;y=stack[d].length;0!=y&&(--y,CardBlank(d,y)&&($(".pos-"+d+"-"+y).remove(),DrawOneCard(d,y,0)));TextEdit(!0);8==stack[11].length&&(TextEdit(!1),started=!1)}
function GamePrepare(d){countery=counterx=counter=0;stack=[];tempstack=[];button=!1;started=!0;pscore=500;pmoves=0;pcancel=[];pview=[];for(i=0;8>i;i++)for(j=0;13>j;j++)tempstack[13*i+j]=j+1+i%d*20;for(i=z=x=0;104>i;i++)z=Math.floor(Math.random()*(104-i)),x=tempstack[z],tempstack.splice(z,1),tempstack.push(x);for(i=0;12>i;i++)stack[i]=[];for(i=0;4>i;i++)stack[i]=tempstack.splice(0,6);for(i=4;10>i;i++)stack[i]=tempstack.splice(0,5);stack[10]=tempstack.splice(0,50);for(i=0;10>i;i++)tempstack[i]=1}
function GameDraw(){$(".card").remove();$(".cardsl").remove();$(".cardsr").remove();for(i=0;10>i;i++){for(j=0;j<stack[i].length-1;j++)DrawOneCard(i,j,1);DrawOneCard(i,j,0)}for(j=0;5>j;j++)DrawOneCard(10,j,1);TextEdit(!0)}
function GameMouse(){$(document).ready(function(){$(document).mousemove(function(d){newPosXY.left=d.pageX-xcard;newPosXY.top=d.pageY+3*ycard;button&&$("#temp").offset(newPosXY)});$(document).mousedown(function(){});$(document).mouseup(function(){0==timerstep&&button&&(CheckColumn(),$(".holder").remove(),$(".notholder").toggleClass("notholder"),CardMUp(lastentry),button=!1)})})}function GameStart(d){0==timerstep&&(GamePrepare(d),GameDraw(),GameMouse())};